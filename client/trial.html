<!DOCTYPE html>
<!--
@licence
    Copyright (c) 2020 Alan Chandler, all rights reserved

    This file is part of Football Mobile.

    Football Mobile is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    Football Mobile is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with Football Mobile.  If not, see <http://www.gnu.org/licenses/>.
-->
<html lang="en">
  <head>

  </head>
  <body>
    <div id="log">

    </div>
<script type="text/javascript">
  // Broadcast that you're opening a page.
  let content;
  const logger = document.getElementById('log');
  const answerPromise = new Promise(resolve => {
    const myTab = Date.now();
    content = `<div><span>${myTab}</span>: Opening Tab ${myTab}</div>`;
    const timer = setTimeout(() => {
      content = `<div><span>${Date.now()}</span>: I am the only open tab id = ${myTab}</div>`;
      logger.innerHTML += content; 
      resolve(true); 
    },20)
    logger.innerHTML += content;
    console.log('Opening tab id', myTab)
    localStorage.setItem('openpages',myTab);
    var onLocalStorageEvent = function (e) {
      if (e.key == "openpages") {
        console.log('OpenPages received from ', e.newValue, 'sending them as page_available', myTab);
        // Listen if anybody else is opening the same page!
        localStorage.setItem('page_available', myTab);
      }
      if (e.key == "page_available") {
        clearTimeout(timer);
        content = `<div><span>${Date.now()}</span>: Another Page already Available id ${e.newValue}</div>`;
        logger.innerHTML += content;
        console.log('Another Page already Available id', e.newValue);
        resolve(false);
      }
    };
    content = `<div><span>${Date.now()}</span>: about to add Event Listener for ${myTab}</div>`;
    logger.innerHTML += content;
    console.log('about to add Event Listener for ', myTab);
    window.addEventListener('storage', onLocalStorageEvent, false);
    content = `<div><span>${Date.now()}</span>: Added Event Listener - now ending script for ${myTab}</div>`;
    logger.innerHTML += content;
    console.log('Added Event Listener - now ending script for', myTab);
  }).then(answer => {
    if (answer) {
      content = 'I am the first tab and can therefore use the remembered token if it exists';
    } else {
      content = 'I am not the first tab and therefore must log on';
    }
    logger.innerHTML += Date.now() + ':' + content;
    console.log(content);

  });
</script>
  </body>
</html>
